<%= javascript_include_tag "dash", :async => true %>
<div id="dash-title-bar">
	<div>Welcome, <%= @user.name %></div>
	<a href="<%= logout_url.to_s %>">logout</a>
</div>

<div class="dash-section">
	<h1>Recruit codes</h1>
	<ul class="recruit-codes">
		<% @codes.each do |code| %>
			<% if @user.children.length == 0%>
				<div class="instruction-dialog">now share this code with someone you want to recruit</div>
			<% end %>
			<li>
				<input id="code-<%= code.code.to_s%>" type="text" class="recruit-code" value="<%= (root_url + code.code).to_s %>" readonly>
				<input type="button" class="copy-button" data-clipboard-target="#code-<%= code.code.to_s%>" value="copy">
				<div
					class="code-expire-time"
					data-hours="<%= code.time_until_expire.strftime "%H" %>"
					data-minutes="<%= code.time_until_expire.strftime "%M" %>" >expires in
					<%= code.time_until_expire.strftime "%H hours %M minutes" %></div>
			</li>
		<% end %>
	</ul>
	<% if @allowed_to_create_codes %>
		<%= form_for :new_code, url: {action: "new_code"} do |f| %>
			<% if @codes.size == 0 && @user.children.length == 0%>
				<div class="instruction-dialog">create a code to start recruiting people into your pyramid</div>
			<% end %>
			<%= f.submit 'new recruit code', :class => 'submit-button' %>
		<% end %>
	<% else %>
		<div class="error-message">
			<ol>
				<li>you've hit your limit for recruit code creation</li>
				<li>your existing codes must expire or be claimed before you can create more</li>
			</ol>
		</div>
	<% end %>
</div>

<div class="dash-section">
	<h1>Earnings <%= as_currency @user.earned, true %></h1>
	<ol>
		<% @user.transactions.each do |transaction| %>
			<li class="transaction-record">
				<div class="currency">+<%= as_currency transaction.amount(@user), true %></div>
				<div class="description">
					<%= transaction.created_at.strftime '%b %d at %H:%M' %>
					when <a><%= transaction.from %></a> was recruited by
					<a><%= (transaction.from.parent == @user) ? 'you' : transaction.from.parent %></a>
				</div>
				<div class="chain">
					<ol>
						<li><a><%= transaction.from %></a></li>
						<%= user_chain transaction.up_to(@user) %>
					</ol>
				</div>
			</li>
		<% end %>
	</ol>
	<% if @user.children.length == 0 %>
		<p>you haven't recruited any subordinates yet</p>
	<% end %>
</div>

<div class="dash-section" id="dash-tree">
	<h1>Your pyramid</h1>

	<input id="tree-ttb" type="radio" name="tree-type" checked="checked">
	<label for="tree-ttb">horizontal</label>
	<input id="tree-ltr" type="radio" name="tree-type">
	<label for="tree-ltr">vertical</label>
	<div class="tree-chooser"></div>

	<div class="tree">
		<ol>
			<li>
				<% if @user.parent %>
					<a><%= @user.parent.name %></a>
				<% end %>
				<%= draw_tree @user.subtree.arrange(:order => :created_at) %>
			</li>
		</ol>
	</div>
</div>
